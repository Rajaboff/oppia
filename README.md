[[_TOC_]]

# Fork oppia release-3.0.4
https://github.com/oppia/oppia

## Что изменилось?

Платформа была разработана для использования в среде **Google App Engine**(GAE). Вход в платформу осуществлялся с 
использование google-аккаунта. Т.е. при входе в платформу, нужно было ввести логин/пароль от google-аккаунта.

Есть возможность запуска платформы с локальным сервером GAE.
Запуск платформы с локальным сервером GAE был расчитан на разработчиков, а не для продакшена. Поэтому, авторизация
выглядит еще проще. Достаточно ввести любой валидный email. Это было сделано для простоты создания пользователей с разными почтовыми ящиками.

Сейчас же планируется использовать платформу с локальным сервером GAE в продакшене. Поэтому, необходимо было переделать
систему регистрации/авторизации. В этом и есть отличие текущей fork-версии от оригинала.

## Хэндлеры

### GET /_ah/login_proxy

В вервыу очередь, нужно было запретить авторизацию только по email. Для этого использовался хэндлер **/_ah/login** c параметром **action=Login**.
На BE реализован хэнделер **/_ah/login_proxy** - делает все тоже самое что и **/_ah/login**, но не позволяет авторизоваться только по email.
Нужно изменить все вызовы **/_ah/login** на вызовы **/_ah/login_proxy**

### POST /custom_auth

Используется для авторизации по почте и паролю.
В параметрах пути нужно передать: `?email=test@example.com&action=Login&continue=http://mydomain.com/signup?return_url=/`, где:
- email - email пользователя
- mydomain.com - домен- ресурса

payload={"password":"Ru77Kq67", "email":"test@example.com"}

### POST /password_recovery_token

Отправляет письмо с токеном на восстановление пароля 
Принимает:
payload={"email":"test@example.com"}
Пользователю будет отправлено письмо со ссылкой типа: http://localhost:8181/password_recovery?token=51099f9044f94351a516a94e1a852e2f
Перейдя по ссылке он должен ввести новый пароль и нажать кнопку "применить". По нажатию на кнопку, нужно отправить
POST-запрос `/token/<token>/password_recovery`. <token> - это токен с которым пришел пользователь. payload={"password":"NEW_PASS"}

### POST /email_confirm_token

Отправляет письмо с токеном на подтверждения почты
Принимает:
payload={"email":"test@example.com"}
Пользователю будет отправлено письмо со ссылкой типа: http://localhost:8181/email_confirm?token=ff4848a0e4d54cd19582094b002307b8
Перейдя по ссылке, пользователь должен попасть на страцицу откуда выполнится POST-запрос `/token/<token>/email_confirm`. <token> - это токен с которым пришел пользователь.
payload={}

### POST /signuphandler/data

Доработан. Используется для создания новых пользователей.
Кроме username теперь еще принимает email, пароль(password) и роль(role). Роль может иметь одно из 2-х значений:
- EXPLORATION_EDITOR - учитель
- LEARNER - ученик

Все параметры обязательны.

### Общее для хэндлеров

Везде, где после выполнения запроса происходит редирект, нужно поправить адрес редиректа. Сейчас даже если приложение открыто на 80-ом порту, после регистрации(или других действий) перебрасывает на порт 8181. Нужно поправить, чтоб редирект
происходил на 80-й. На сколько я понял, это зависит от параметра `continue` в параметрах запроса.

## Nginx

Nginx необходим для запрета старой системы авторизации(только по email)
Платформа поднимается на порту 8181, а nginx на 80. Наружу светим 80. Перенаправляем все запросы c 80 на 8181 кроме
запросов на `/_ah/login`, таким образом запретим старую авторизацию.

### Установка nginx

```bash
sudo apt update
sudo apt install nginx
sudo systemctl enable nginx
```

### Настройка nginx

1. Переходим в дирректорию с oppia
2. Перезаписываем файл и перезапускаем nginx
```bash
sudo systemctl stop nginx
sudo cat nginx.conf > /etc/nginx/nginx.conf
sudo systemctl start nginx
```

## Описание CI/CD

- Для каждого push'a в репозиторий можно запустить джобу `deploy` - она предназначена для развертывания на prod-сервере версии с вашими измененими, так что думайте прежде чем ее запускать.

- На `master` можно запускать джобу `build` - она пересобирет базовый образ для поднятия проекта из версии, которая сейчас развернута на prod-сервере и перезальет образ в https://hub.docker.com/repository/docker/akhanbakhitov777/oqustudy.

## Как поднять проект в докере на своей машине

На примере Ubuntu:

1. Клонируем себе текущий проект 

```bash
https://gitlab.com/AkhanBakhitov/oppia.git
```

2. Переходим в дирректорию проекта

```bash
cd oppia
```

3. Устанавливаем docker. Вот [официальная дока](https://docs.docker.com/engine/install/)
4. Регаемся в https://hub.docker.com/
5. Запрашиваем у @AkhanBakhitov доступ к https://hub.docker.com/repository/docker/akhanbakhitov777/oqustudy
6. Логинимся используя docker:

```bash
docker login --username <your_username> --password <your_password>
```

7. Скачиваем образ для запуска проекта

```bash
docker pull akhanbakhitov777/oqustudy:latest
```

8. Создаем в домашнем каталоге директорию для хранения контента проекта(что-то типо базы):

```bash
mkdir -p ~/appengine.None.root
```

9. Создаем и запускаем контейнер с проектом

```bash
docker run -d --name oqustudy -p 80:80 -v "~/appengine.None.root/:/tmp" -v "${PWD}/../oppia:/oppia" akhanbakhitov777/oqustudy
```

где:
- `-p 80:80` - прокидываем порт из докера на localhost
- `-v "~/appengine.None.root/:/tmp"` - прокидываем локальную базу в докер, все изменения останутся в ней даже если остановить и удалить контейнер с приложением
- `-v "${PWD}/../oppia:/oppia"` - прокидываем локальную директорию с проектом в контейнер с приложением. Т.е. все изменения сделанные локально - автоматически попадают в контейнер, как будто приложение и не в докере вовсе.

Лог контейнера можно смотреть так:

```bash
docker logs -f oqustudy
```

После запуска приложение будет доступно на: 127.0.0.1

## Docker cheat sheets

- docker run ... - создает контейнер из образа и запускает его
- docker rm <container_name> - удаляет контейнер
- docker stop <container_name> - останавливает контейнер
- docker start <container_name> - запускает ранее созданный контейнер

После перезагрузки системы достаточно выполнить `docker start oqustudy` и приложение снова запустится
